


ARM Macro Assembler    Page 1 CMPE 250 Exercise Twelve


    1 00000000                 TTL              CMPE 250 Exercise Twelve
    2 00000000         ;****************************************************************
    3 00000000         ;This program runs a simple game where you have to
    4 00000000         ;input the LED's shown on the board. It uses a random
    5 00000000         ;number generator based on the current time.
    6 00000000         ;Name:   Jonathan Hubbard, Jay Mantini
    7 00000000         ;Date:   11-30-17
    8 00000000         ;Class:   CMPE-250
    9 00000000         ;Section:   L4, Thursday 11:00am-1:00pm
   10 00000000         ;---------------------------------------------------------------
   11 00000000         ;Keil Template for KL46
   12 00000000         ;R. W. Melton
   13 00000000         ;September 25, 2017
   14 00000000         ;****************************************************************
   15 00000000         ;Assembler directives
   16 00000000                 THUMB
   18 00000000         ;****************************************************************
   19 00000000         ;Include files
   20 00000000                 GET              MKL46Z4.s   ;Included by start.s
   22 00000000         ;****************************************************************
   23 00000000         ;EQUates
   24 00000000 00000004 
                       QBuffer EQU              4
   25 00000000 00000050 
                       RxQBuffer
                               EQU              80
   26 00000000 00000050 
                       TxQBuffer
                               EQU              80
   27 00000000         
   28 00000000 00000000 
                       IN_PTR  EQU              0
   29 00000000 00000004 
                       OUT_PTR EQU              4
   30 00000000 00000008 
                       BUF_STRT
                               EQU              8
   31 00000000 0000000C 
                       BUF_PAST
                               EQU              12
   32 00000000 00000010 
                       BUF_SIZE



ARM Macro Assembler    Page 2 CMPE 250 Exercise Twelve


                               EQU              16
   33 00000000 00000011 
                       NUM_ENQD
                               EQU              17
   34 00000000         
   35 00000000 0000004F 
                       MAX_STRING
                               EQU              79
   36 00000000         ;---------------------------------------------------------------
   37 00000000         ;LED Stuff
   38 00000000         ;Port D
   39 00000000 00000100 
                       PTD5_MUX_GPIO
                               EQU              (1 << PORT_PCR_MUX_SHIFT)
   40 00000000 01000100 
                       SET_PTD5_GPIO
                               EQU              (PORT_PCR_ISF_MASK :OR: PTD5_MUX_GPIO)
   41 00000000         ;Port E
   42 00000000 00000100 
                       PTE29_MUX_GPIO
                               EQU              (1 << PORT_PCR_MUX_SHIFT)
   43 00000000 01000100 
                       SET_PTE29_GPIO
                               EQU              (PORT_PCR_ISF_MASK :OR: PTE29_MUX_GPIO)
   44 00000000         
   45 00000000 0000001D 
                       POS_RED EQU              29
   46 00000000 00000005 
                       POS_GREEN
                               EQU              5
   47 00000000 20000000 
                       LED_RED_MASK
                               EQU              (1 << POS_RED)
   48 00000000 00000020 
                       LED_GREEN_MASK
                               EQU              (1 << POS_GREEN)
   49 00000000 00000020 
                       LED_PORTD_MASK
                               EQU              LED_GREEN_MASK
   50 00000000 20000000 
                       LED_PORTE_MASK
                               EQU              LED_RED_MASK



ARM Macro Assembler    Page 3 CMPE 250 Exercise Twelve


   51 00000000         ;---------------------------------------------------------------
   52 00000000         ;NVIC_ICER
   53 00000000         ;31-00:CLRENA=masks for HW IRQ sources;
   54 00000000         ;             read:   0 = unmasked;   1 = masked
   55 00000000         ;             write:  0 = no effect;  1 = mask
   56 00000000         ;22:PIT IRQ mask
   57 00000000         ;12:UART0 IRQ mask
   58 00000000 00400000 
                       NVIC_ICER_PIT_MASK
                               EQU              PIT_IRQ_MASK
   59 00000000 00001000 
                       NVIC_ICER_UART0_MASK
                               EQU              UART0_IRQ_MASK
   60 00000000         ;---------------------------------------------------------------
   61 00000000         ;NVIC_ICPR
   62 00000000         ;31-00:CLRPEND=pending status for HW IRQ sources;
   63 00000000         ;             read:   0 = not pending;  1 = pending
   64 00000000         ;             write:  0 = no effect;
   65 00000000         ;                     1 = change status to not pending
   66 00000000         ;22:PIT IRQ pending status
   67 00000000         ;12:UART0 IRQ pending status
   68 00000000 00400000 
                       NVIC_ICPR_PIT_MASK
                               EQU              PIT_IRQ_MASK
   69 00000000 00001000 
                       NVIC_ICPR_UART0_MASK
                               EQU              UART0_IRQ_MASK
   70 00000000         ;---------------------------------------------------------------
   71 00000000         ;NVIC_IPR0-NVIC_IPR7
   72 00000000         ;2-bit priority:  00 = highest; 11 = lowest
   73 00000000         ;--PIT
   74 00000000 00000000 
                       PIT_IRQ_PRIORITY
                               EQU              0
   75 00000000 00C00000 
                       NVIC_IPR_PIT_MASK
                               EQU              (3 << PIT_PRI_POS)
   76 00000000 00000000 
                       NVIC_IPR_PIT_PRI_0
                               EQU              (PIT_IRQ_PRIORITY << UART0_PRI_POS)
   77 00000000         ;--UART0
   78 00000000 00000003 



ARM Macro Assembler    Page 4 CMPE 250 Exercise Twelve


                       UART0_IRQ_PRIORITY
                               EQU              3
   79 00000000 000000C0 
                       NVIC_IPR_UART0_MASK
                               EQU              (3 << UART0_PRI_POS)
   80 00000000 000000C0 
                       NVIC_IPR_UART0_PRI_3
                               EQU              (UART0_IRQ_PRIORITY << UART0_PRI_POS)
   81 00000000         ;---------------------------------------------------------------
   82 00000000         ;NVIC_ISER
   83 00000000         ;31-00:SETENA=masks for HW IRQ sources;
   84 00000000         ;             read:   0 = masked;     1 = unmasked
   85 00000000         ;             write:  0 = no effect;  1 = unmask
   86 00000000         ;22:PIT IRQ mask
   87 00000000         ;12:UART0 IRQ mask
   88 00000000 00400000 
                       NVIC_ISER_PIT_MASK
                               EQU              PIT_IRQ_MASK
   89 00000000 00001000 
                       NVIC_ISER_UART0_MASK
                               EQU              UART0_IRQ_MASK
   90 00000000         ;---------------------------------------------------------------
   91 00000000         ;PIT_LDVALn:  PIT load value register n
   92 00000000         ;31-00:TSV=timer start value (period in clock cycles - 1)
   93 00000000         ;Clock ticks for 0.01 s at 24 MHz count rate
   94 00000000         ;0.01 s * 24,000,000 Hz = 240,000
   95 00000000         ;TSV = 240,000 - 1
   96 00000000 0003A97F 
                       PIT_LDVAL_10ms
                               EQU              239999
   97 00000000         ;---------------------------------------------------------------
   98 00000000         ;PIT_MCR:  PIT module control register
   99 00000000         ;1-->    0:FRZ=freeze (continue'/stop in debug mode)
  100 00000000         ;0-->    1:MDIS=module disable (PIT section)
  101 00000000         ;               RTI timer not affected
  102 00000000         ;               must be enabled before any other PIT setup
  103 00000000 00000001 
                       PIT_MCR_EN_FRZ
                               EQU              PIT_MCR_FRZ_MASK
  104 00000000         ;---------------------------------------------------------------
  105 00000000         ;PIT_TCTRLn:  PIT timer control register n
  106 00000000         ;0-->   2:CHN=chain mode (enable)



ARM Macro Assembler    Page 5 CMPE 250 Exercise Twelve


  107 00000000         ;1-->   1:TIE=timer interrupt enable
  108 00000000         ;1-->   0:TEN=timer enable
  109 00000000 00000003 
                       PIT_TCTRL_CH_IE
                               EQU              (PIT_TCTRL_TEN_MASK :OR: PIT_TCTRL_TIE_MASK)
  110 00000000         ;---------------------------------------------------------------
  111 00000000         ;PORTx_PCRn (Port x pin control register n [for pin n])
  112 00000000         ;___->10-08:Pin mux control (select 0 to 8)
  113 00000000         ;Use provided PORT_PCR_MUX_SELECT_2_MASK
  114 00000000         ;---------------------------------------------------------------
  115 00000000         ;Port A
  117 00000000 01000200 
                       PORT_PCR_SET_PTA1_UART0_RX
                               EQU              (PORT_PCR_ISF_MASK :OR:                                    PORT_PCR_MUX
_SELECT_2_MASK)
  119 00000000 01000200 
                       PORT_PCR_SET_PTA2_UART0_TX
                               EQU              (PORT_PCR_ISF_MASK :OR:                                    PORT_PCR_MUX
_SELECT_2_MASK)
  120 00000000         ;---------------------------------------------------------------
  121 00000000         ;SIM_SCGC4
  122 00000000         ;1->10:UART0 clock gate control (enabled)
  123 00000000         ;Use provided SIM_SCGC4_UART0_MASK
  124 00000000         ;---------------------------------------------------------------
  125 00000000         ;SIM_SCGC5
  126 00000000         ;1->09:Port A clock gate control (enabled)
  127 00000000         ;Use provided SIM_SCGC5_PORTA_MASK
  128 00000000         ;---------------------------------------------------------------
  129 00000000         ;SIM_SOPT2
  130 00000000         ;01=27-26:UART0SRC=UART0 clock source select
  131 00000000         ;         (PLLFLLSEL determines MCGFLLCLK' or MCGPLLCLK/2)
  132 00000000         ; 1=   16:PLLFLLSEL=PLL/FLL clock select (MCGPLLCLK/2)
  134 00000000 04000000 
                       SIM_SOPT2_UART0SRC_MCGPLLCLK
                               EQU              (1 << SIM_SOPT2_UART0SRC_SHIFT)
  136 00000000 04010000 
                       SIM_SOPT2_UART0_MCGPLLCLK_DIV2
                               EQU              (SIM_SOPT2_UART0SRC_MCGPLLCLK :OR: SIM_SOPT2_PLLFLLSEL_MASK)
  137 00000000         ;---------------------------------------------------------------
  138 00000000         ;SIM_SOPT5
  139 00000000         ; 0->   16:UART0 open drain enable (disabled)
  140 00000000         ; 0->   02:UART0 receive data select (UART0_RX)



ARM Macro Assembler    Page 6 CMPE 250 Exercise Twelve


  141 00000000         ;00->01-00:UART0 transmit data select source (UART0_TX)
  145 00000000 00010007 
                       SIM_SOPT5_UART0_EXTERN_MASK_CLEAR
                               EQU              (SIM_SOPT5_UART0ODE_MASK :OR:                                  SIM_SOPT
5_UART0RXSRC_MASK :OR:                                  SIM_SOPT5_UART0TXSRC_MASK)
  146 00000000         ;---------------------------------------------------------------
  147 00000000         ;UART0_BDH
  148 00000000         ;    0->  7:LIN break detect IE (disabled)
  149 00000000         ;    0->  6:RxD input active edge IE (disabled)
  150 00000000         ;    0->  5:Stop bit number select (1)
  151 00000000         ;00001->4-0:SBR[12:0] (UART0CLK / [9600 * (OSR + 1)]) 
  152 00000000         ;UART0CLK is MCGPLLCLK/2
  153 00000000         ;MCGPLLCLK is 96 MHz
  154 00000000         ;MCGPLLCLK/2 is 48 MHz
  155 00000000         ;SBR = 48 MHz / (9600 * 16) = 312.5 --> 312 = 0x138
  156 00000000 00000001 
                       UART0_BDH_9600
                               EQU              0x01
  157 00000000         ;---------------------------------------------------------------
  158 00000000         ;UART0_BDL
  159 00000000         ;26->7-0:SBR[7:0] (UART0CLK / [9600 * (OSR + 1)])
  160 00000000         ;UART0CLK is MCGPLLCLK/2
  161 00000000         ;MCGPLLCLK is 96 MHz
  162 00000000         ;MCGPLLCLK/2 is 48 MHz
  163 00000000         ;SBR = 48 MHz / (9600 * 16) = 312.5 --> 312 = 0x138
  164 00000000 00000038 
                       UART0_BDL_9600
                               EQU              0x38
  165 00000000         ;---------------------------------------------------------------
  166 00000000         ;UART0_C1
  167 00000000         ;0-->7:LOOPS=loops select (normal)
  168 00000000         ;0-->6:DOZEEN=doze enable (disabled)
  169 00000000         ;0-->5:RSRC=receiver source select (internal--no effect LOOPS=0)
  170 00000000         ;0-->4:M=9- or 8-bit mode select 
  171 00000000         ;        (1 start, 8 data [lsb first], 1 stop)
  172 00000000         ;0-->3:WAKE=receiver wakeup method select (idle)
  173 00000000         ;0-->2:IDLE=idle line type select (idle begins after start bit)
  174 00000000         ;0-->1:PE=parity enable (disabled)
  175 00000000         ;0-->0:PT=parity type (even parity--no effect PE=0)
  176 00000000 00000000 
                       UART0_C1_8N1
                               EQU              0x00



ARM Macro Assembler    Page 7 CMPE 250 Exercise Twelve


  177 00000000         ;---------------------------------------------------------------
  178 00000000         ;UART0_C2
  179 00000000         ;0-->7:TIE=transmit IE for TDRE (disabled)
  180 00000000         ;0-->6:TCIE=transmission complete IE for TC (disabled)
  181 00000000         ;0-->5:RIE=receiver IE for RDRF (disabled)
  182 00000000         ;0-->4:ILIE=idle line IE for IDLE (disabled)
  183 00000000         ;1-->3:TE=transmitter enable (enabled)
  184 00000000         ;1-->2:RE=receiver enable (enabled)
  185 00000000         ;0-->1:RWU=receiver wakeup control (normal)
  186 00000000         ;0-->0:SBK=send break (disabled, normal)
  187 00000000 0000000C 
                       UART0_C2_T_R
                               EQU              (UART0_C2_TE_MASK :OR: UART0_C2_RE_MASK)
  188 00000000 0000002C 
                       UART0_C2_T_RI
                               EQU              (UART0_C2_RIE_MASK :OR: UART0_C2_T_R)
  189 00000000 000000AC 
                       UART0_C2_TI_RI
                               EQU              (UART0_C2_TIE_MASK :OR: UART0_C2_T_RI)
  190 00000000         ;---------------------------------------------------------------
  191 00000000         ;UART0_C3
  192 00000000         ;0-->7:R8T9=9th data bit for receiver (not used M=0)
  193 00000000         ;           10th data bit for transmitter (not used M10=0)
  194 00000000         ;0-->6:R9T8=9th data bit for transmitter (not used M=0)
  195 00000000         ;           10th data bit for receiver (not used M10=0)
  196 00000000         ;0-->5:TXDIR=UART_TX pin direction in single-wire mode
  197 00000000         ;            (no effect LOOPS=0)
  198 00000000         ;0-->4:TXINV=transmit data inversion (not inverted)
  199 00000000         ;0-->3:ORIE=overrun IE for OR (disabled)
  200 00000000         ;0-->2:NEIE=noise error IE for NF (disabled)
  201 00000000         ;0-->1:FEIE=framing error IE for FE (disabled)
  202 00000000         ;0-->0:PEIE=parity error IE for PF (disabled)
  203 00000000 00000000 
                       UART0_C3_NO_TXINV
                               EQU              0x00
  204 00000000         ;---------------------------------------------------------------
  205 00000000         ;UART0_C4
  206 00000000         ;    0-->  7:MAEN1=match address mode enable 1 (disabled)
  207 00000000         ;    0-->  6:MAEN2=match address mode enable 2 (disabled)
  208 00000000         ;    0-->  5:M10=10-bit mode select (not selected)
  209 00000000         ;01111-->4-0:OSR=over sampling ratio (16)
  210 00000000         ;               = 1 + OSR for 3 <= OSR <= 31



ARM Macro Assembler    Page 8 CMPE 250 Exercise Twelve


  211 00000000         ;               = 16 for 0 <= OSR <= 2 (invalid values)
  212 00000000 0000000F 
                       UART0_C4_OSR_16
                               EQU              0x0F
  213 00000000 0000000F 
                       UART0_C4_NO_MATCH_OSR_16
                               EQU              UART0_C4_OSR_16
  214 00000000         ;---------------------------------------------------------------
  215 00000000         ;UART0_C5
  216 00000000         ;  0-->  7:TDMAE=transmitter DMA enable (disabled)
  217 00000000         ;  0-->  6:Reserved; read-only; always 0
  218 00000000         ;  0-->  5:RDMAE=receiver full DMA enable (disabled)
  219 00000000         ;000-->4-2:Reserved; read-only; always 0
  220 00000000         ;  0-->  1:BOTHEDGE=both edge sampling (rising edge only)
  221 00000000         ;  0-->  0:RESYNCDIS=resynchronization disable (enabled)
  222 00000000 00000000 
                       UART0_C5_NO_DMA_SSR_SYNC
                               EQU              0x00
  223 00000000         ;---------------------------------------------------------------
  224 00000000         ;UART0_S1
  225 00000000         ;0-->7:TDRE=transmit data register empty flag; read-only
  226 00000000         ;0-->6:TC=transmission complete flag; read-only
  227 00000000         ;0-->5:RDRF=receive data register full flag; read-only
  228 00000000         ;1-->4:IDLE=idle line flag; write 1 to clear (clear)
  229 00000000         ;1-->3:OR=receiver overrun flag; write 1 to clear (clear)
  230 00000000         ;1-->2:NF=noise flag; write 1 to clear (clear)
  231 00000000         ;1-->1:FE=framing error flag; write 1 to clear (clear)
  232 00000000         ;1-->0:PF=parity error flag; write 1 to clear (clear)
  233 00000000 0000001F 
                       UART0_S1_CLEAR_FLAGS
                               EQU              0x1F
  234 00000000         ;---------------------------------------------------------------
  235 00000000         ;UART0_S2
  236 00000000         ;1-->7:LBKDIF=LIN break detect interrupt flag (clear)
  237 00000000         ;             write 1 to clear
  238 00000000         ;1-->6:RXEDGIF=RxD pin active edge interrupt flag (clear)
  239 00000000         ;              write 1 to clear
  240 00000000         ;0-->5:(reserved); read-only; always 0
  241 00000000         ;0-->4:RXINV=receive data inversion (disabled)
  242 00000000         ;0-->3:RWUID=receive wake-up idle detect
  243 00000000         ;0-->2:BRK13=break character generation length (10)
  244 00000000         ;0-->1:LBKDE=LIN break detect enable (disabled)



ARM Macro Assembler    Page 9 CMPE 250 Exercise Twelve


  245 00000000         ;0-->0:RAF=receiver active flag; read-only
  246 00000000 000000C0 
                       UART0_S2_NO_RXINV_BRK10_NO_LBKDETECT_CLEAR_FLAGS
                               EQU              0xC0
  247 00000000         ;---------------------------------------------------------------
  248 00000000         ;Program
  249 00000000         ;Linker requires Reset_Handler
  250 00000000                 AREA             MyCode,CODE,READONLY
  251 00000000                 ENTRY
  252 00000000                 EXPORT           Reset_Handler
  253 00000000                 IMPORT           Startup
  254 00000000         Reset_Handler
                               PROC             {},{}
  255 00000000         main
  256 00000000         ;---------------------------------------------------------------
  257 00000000         ;Mask interrupts
  258 00000000 B672            CPSID            I
  259 00000002         ;KL46 system startup with 48-MHz system clock
  260 00000002 F7FF FFFE       BL               Startup
  261 00000006         ;---------------------------------------------------------------
  262 00000006         ;>>>>> begin main program code <<<<<
  263 00000006 F7FF FFFE       BL               Init_UART0_IRQ
  264 0000000A F7FF FFFE       BL               Init_PIT_IRQ
  265 0000000E F7FF FFFE       BL               Init_LED
  266 00000012 F7FF FFFE       BL               RedDisable
  267 00000016 F7FF FFFE       BL               GreenDisable
  268 0000001A         
  269 0000001A 2200            MOVS             R2,#0       ;Initialize Round counter
  270 0000001C 214F            MOVS             R1,#MAX_STRING
  271 0000001E 4D61            LDR              R5,=Score
  272 00000020 602A            STR              R2,[R5,#0]  ;Initialize Score to 0
  273 00000022         
  274 00000022 2000            MOVS             R0,#0
  275 00000024 4C60            LDR              R4,=Count
  276 00000026 6020            STR              R0,[R4,#0]  ;Set Count to 0
  277 00000028 2001            MOVS             R0,#1
  278 0000002A 4C60            LDR              R4,=RunStopWatch
  279 0000002C 7020            STRB             R0,[R4,#0]  ;Enable RunStopWatch
  280 0000002E         
  281 0000002E 4860            LDR              R0,=Welcome ;Print the entire beginning message set
  282 00000030 F7FF FFFE       BL               PutStringSB
  283 00000034 F7FF FFFE       BL               NewLine



ARM Macro Assembler    Page 10 CMPE 250 Exercise Twelve


  284 00000038 485E            LDR              R0,=Instruct1
  285 0000003A F7FF FFFE       BL               PutStringSB
  286 0000003E F7FF FFFE       BL               NewLine
  287 00000042 485D            LDR              R0,=Instruct2
  288 00000044 F7FF FFFE       BL               PutStringSB
  289 00000048 F7FF FFFE       BL               NewLine
  290 0000004C 485B            LDR              R0,=Instruct3
  291 0000004E F7FF FFFE       BL               PutStringSB
  292 00000052 F7FF FFFE       BL               NewLine
  293 00000056 485A            LDR              R0,=Instruct4
  294 00000058 F7FF FFFE       BL               PutStringSB
  295 0000005C F7FF FFFE       BL               NewLine
  296 00000060 4858            LDR              R0,=Instruct5
  297 00000062 F7FF FFFE       BL               PutStringSB
  298 00000066 F7FF FFFE       BL               NewLine
  299 0000006A 4857            LDR              R0,=Instruct6
  300 0000006C F7FF FFFE       BL               PutStringSB
  301 00000070 F7FF FFFE       BL               NewLine
  302 00000074         
  303 00000074 F7FF FFFE       BL               GetChar     ;Wait for user to start game
  304 00000078         
  305 00000078         ;---------------------------------------------------------------
  306 00000078         ;Main Code Register Usages
  307 00000078         ;R0 = Temporary value
  308 00000078         ;R1 = MAX_STRING, used for PutStringSB
  309 00000078         ;R2 = Round counter, incremented each round
  310 00000078         ;R3 = Random number, used for lighting LED(s)
  311 00000078         ;R4 = Address for message corresponding to R3 (red, both, etc.)
  312 00000078         ;R5 = Temporary value
  313 00000078         ;---------------------------------------------------------------
  314 00000078         
  315 00000078         MainLoop
  316 00000078 1C52            ADDS             R2,R2,#1    ;Increment Round counter
  317 0000007A F7FF FFFE       BL               RandomGen   ;R3 = Number from 0-3
  318 0000007E         
  319 0000007E         ;-------RANDOM NUMBER PROCESSING---------------------------------
  320 0000007E         
  321 0000007E 2B03            CMP              R3,#3
  322 00000080 D105            BNE              Check1      ;3 = Both
  323 00000082 F7FF FFFE       BL               RedEnable
  324 00000086 F7FF FFFE       BL               GreenEnable
  325 0000008A 4C50            LDR              R4,=BothMsg ;Load message for later use



ARM Macro Assembler    Page 11 CMPE 250 Exercise Twelve


  326 0000008C E00D            B                StartRound
  327 0000008E         
  328 0000008E 2B02    Check1  CMP              R3,#2
  329 00000090 D103            BNE              Check2      ;2 = Green
  330 00000092 F7FF FFFE       BL               GreenEnable
  331 00000096 4C4E            LDR              R4,=GreenMsg ;Load message for later use
  332 00000098 E007            B                StartRound
  333 0000009A         
  334 0000009A 2B01    Check2  CMP              R3,#1
  335 0000009C D103            BNE              Check3      ;1 = Red
  336 0000009E F7FF FFFE       BL               RedEnable
  337 000000A2 4C4C            LDR              R4,=RedMsg  ;Load message for later use
  338 000000A4 E001            B                StartRound
  339 000000A6         
  340 000000A6         Check3                               ;0 = None
  341 000000A6 4C4C            LDR              R4,=NoneMsg ;Load message for later use
  342 000000A8 E7FF            B                StartRound
  343 000000AA         
  344 000000AA         ;-------ROUND GUESS PROCESSING-----------------------------------
  345 000000AA         
  346 000000AA 484C    StartRound
                               LDR              R0,=RightArrow
  347 000000AC F7FF FFFE       BL               PutStringSB
  348 000000B0         
  349 000000B0 2000            MOVS             R0,#0
  350 000000B2 4D3D            LDR              R5,=Count
  351 000000B4 6028            STR              R0,[R5,#0]  ;Set Count to 0
  352 000000B6 2001            MOVS             R0,#1
  353 000000B8 4D3C            LDR              R5,=RunStopWatch
  354 000000BA 7028            STRB             R0,[R5,#0]  ;Enable RunStopWatch
  355 000000BC         
  356 000000BC F7FF FFFE       BL               GetInput
  357 000000C0 2800            CMP              R0,#0
  358 000000C2 D03C            BEQ              OutOfTime   ;If R0 = 0, then there was no input
  359 000000C4         
  360 000000C4 F7FF FFFE       BL               PutChar     ;Display character
  361 000000C8         
  362 000000C8 285B            CMP              R0,#91      ;Compares R0 to the Ascii value right after the uppercase le
                                                            tters
  363 000000CA DB00            BLT              CheckB      ;Branches if R0 is uppercase
  364 000000CC 3820            SUBS             R0,R0,#32   ;Converts lowercase to uppercase
  365 000000CE         



ARM Macro Assembler    Page 12 CMPE 250 Exercise Twelve


  366 000000CE 2842    CheckB  CMP              R0,#'B'     ;Checks if R0 is B
  367 000000D0 D10A            BNE              CheckG      ;If it isn't, branch to next check
  368 000000D2 2B03            CMP              R3,#3
  369 000000D4 D12F            BNE              WrongInput  ;If both LED's aren't on, input is wrong
  370 000000D6         
  371 000000D6 4842            LDR              R0,=CorrectMsg
  372 000000D8 F7FF FFFE       BL               PutStringSB
  373 000000DC 0020            MOVS             R0,R4       ;Load message value from earlier
  374 000000DE F7FF FFFE       BL               PutStringSB
  375 000000E2 F7FF FFFE       BL               ComputeScore
  376 000000E6 E030            B                EndRound
  377 000000E8         
  378 000000E8 2847    CheckG  CMP              R0,#'G'     ;Checks if R0 is G
  379 000000EA D10A            BNE              CheckR      ;If it isn't, branch to next check
  380 000000EC 2B02            CMP              R3,#2
  381 000000EE D122            BNE              WrongInput  ;If the Green LED isn't lit, input is wrong
  382 000000F0         
  383 000000F0 483B            LDR              R0,=CorrectMsg
  384 000000F2 F7FF FFFE       BL               PutStringSB
  385 000000F6 0020            MOVS             R0,R4       ;Load message value from earlier
  386 000000F8 F7FF FFFE       BL               PutStringSB
  387 000000FC F7FF FFFE       BL               ComputeScore
  388 00000100 E023            B                EndRound
  389 00000102         
  390 00000102 2852    CheckR  CMP              R0,#'R'     ;Checks if R0 is R
  391 00000104 D10A            BNE              CheckN      ;If it isn't, branch to next check
  392 00000106 2B01            CMP              R3,#1
  393 00000108 D115            BNE              WrongInput  ;If the Red LED isn't lit, input is wrong
  394 0000010A         
  395 0000010A 4835            LDR              R0,=CorrectMsg
  396 0000010C F7FF FFFE       BL               PutStringSB
  397 00000110 0020            MOVS             R0,R4       ;Load message value from earlier
  398 00000112 F7FF FFFE       BL               PutStringSB
  399 00000116 F7FF FFFE       BL               ComputeScore
  400 0000011A E016            B                EndRound
  401 0000011C         
  402 0000011C 284E    CheckN  CMP              R0,#'N'     ;Checks if R0 is N
  403 0000011E D10A            BNE              WrongInput  ;If it isn't, input is wrong
  404 00000120 2B00            CMP              R3,#0
  405 00000122 D108            BNE              WrongInput  ;If either LED is on, input is wrong
  406 00000124         
  407 00000124 482E            LDR              R0,=CorrectMsg



ARM Macro Assembler    Page 13 CMPE 250 Exercise Twelve


  408 00000126 F7FF FFFE       BL               PutStringSB
  409 0000012A 0020            MOVS             R0,R4       ;Load message value from earlier
  410 0000012C F7FF FFFE       BL               PutStringSB
  411 00000130 F7FF FFFE       BL               ComputeScore
  412 00000134 E009            B                EndRound
  413 00000136         
  414 00000136 482B    WrongInput
                               LDR              R0,=WrongMsg
  415 00000138 F7FF FFFE       BL               PutStringSB
  416 0000013C E005            B                EndRound
  417 0000013E         
  418 0000013E 482A    OutOfTime
                               LDR              R0,=OutOfTimeMsg
  419 00000140 F7FF FFFE       BL               PutStringSB
  420 00000144 0020            MOVS             R0,R4       ;Load message value from earlier
  421 00000146 F7FF FFFE       BL               PutStringSB
  422 0000014A         
  423 0000014A F7FF FFFE 
                       EndRound
                               BL               NewLine
  424 0000014E F7FF FFFE       BL               RedDisable
  425 00000152 F7FF FFFE       BL               GreenDisable
  426 00000156 2A0A            CMP              R2,#10
  427 00000158 D18E            BNE              MainLoop    ;Loop until Round 10
  428 0000015A         
  429 0000015A 4824            LDR              R0,=ThanksMsg ;Display thanks and score messages
  430 0000015C F7FF FFFE       BL               PutStringSB
  431 00000160 F7FF FFFE       BL               NewLine
  432 00000164 4822            LDR              R0,=ScoreMsg
  433 00000166 F7FF FFFE       BL               PutStringSB
  434 0000016A         
  435 0000016A 4D0E            LDR              R5,=Score
  436 0000016C 6828            LDR              R0,[R5,#0]  ;Load score into R0 for PutNumU
  437 0000016E F7FF FFFE       BL               PutNumU
  438 00000172 F7FF FFFE       BL               NewLine
  439 00000176         
  440 00000176 481F            LDR              R0,=ReplayMsg ;Display replay prompt
  441 00000178 F7FF FFFE       BL               PutStringSB
  442 0000017C F7FF FFFE       BL               NewLine
  443 00000180         
  444 00000180         ReplayLoop
  445 00000180 F7FF FFFE       BL               GetChar



ARM Macro Assembler    Page 14 CMPE 250 Exercise Twelve


  446 00000184         
  447 00000184 285B            CMP              R0,#91      ;Compares R0 to the Ascii value right after the uppercase le
                                                            tters
  448 00000186 DB00            BLT              CheckYes    ;Branches if R0 is uppercase
  449 00000188 3820            SUBS             R0,R0,#32   ;Converts lowercase to uppercase
  450 0000018A         
  451 0000018A 2859    CheckYes
                               CMP              R0,#'Y'     ;Checks if R0 is Y
  452 0000018C D104            BNE              CheckNo     ;If it isn't, branch to next check
  453 0000018E         
  454 0000018E F7FF FFFE       BL               NewLine
  455 00000192 2200            MOVS             R2,#0       ;Reinitialize round counter
  456 00000194 602A            STR              R2,[R5,#0]  ;Reset score to 0
  457 00000196 E76F            B                MainLoop
  458 00000198         
  459 00000198 284E    CheckNo CMP              R0,#'N'     ;Checks if R0 is N
  460 0000019A D1F1            BNE              ReplayLoop  ;Loop until they enter Y or N
  461 0000019C         
  462 0000019C 4816            LDR              R0,=GoodbyeMsg
  463 0000019E F7FF FFFE       BL               PutStringSB
  464 000001A2         
  465 000001A2         ;>>>>>   end main program code <<<<<
  466 000001A2         ;Stay here
  467 000001A2 E7FE            B                .
  468 000001A4 00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 



ARM Macro Assembler    Page 15 CMPE 250 Exercise Twelve


              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000         LTORG
  469 00000214                 ENDP
  470 00000214         
  471 00000214         ;>>>>> begin subroutine code <<<<<
  472 00000214         Init_UART0_IRQ
                               PROC             {R0-R13}
  473 00000214         ;Purpose:  Initializes the KL46 for interrupts
  474 00000214         ;Calls:  InitQueue
  475 00000214         ;Inputs: 
  476 00000214         ;Outputs: 
  477 00000214         ;Modified: R14-R15,APSR
  478 00000214         
  479 00000214         ;Pushes R0-R3 and LR onto the stack
  480 00000214 B50F            PUSH             {R0-R3,LR}
  481 00000216         
  482 00000216         ;Initialize recieve queue record structure
  483 00000216 48DA            LDR              R0,=RxQueue
  484 00000218 49DA            LDR              R1,=RxQRecord
  485 0000021A 4ADB            LDR              R2,=RxQBuffer
  486 0000021C F7FF FFFE       BL               InitQueue
  487 00000220         
  488 00000220         ;Initialize transmit queue record structure
  489 00000220 48DA            LDR              R0,=TxQueue
  490 00000222 49DB            LDR              R1,=TxQRecord
  491 00000224 4AD8            LDR              R2,=TxQBuffer
  492 00000226 F7FF FFFE       BL               InitQueue
  493 0000022A         
  494 0000022A         ;Select MCGPLLCLK / 2 as UART0 clock source
  495 0000022A 48DA            LDR              R0,=SIM_SOPT2
  496 0000022C 49DA            LDR              R1,=SIM_SOPT2_UART0SRC_MASK
  497 0000022E 6802            LDR              R2,[R0,#0]
  498 00000230 438A            BICS             R2,R2,R1
  499 00000232 49DA            LDR              R1,=SIM_SOPT2_UART0_MCGPLLCLK_DIV2



ARM Macro Assembler    Page 16 CMPE 250 Exercise Twelve


  500 00000234 430A            ORRS             R2,R2,R1
  501 00000236 6002            STR              R2,[R0,#0]
  502 00000238         
  503 00000238         ;Enable external connection for UART0     
  504 00000238 48D9            LDR              R0,=SIM_SOPT5
  505 0000023A 49DA            LDR              R1,=SIM_SOPT5_UART0_EXTERN_MASK_CLEAR
  506 0000023C 6802            LDR              R2,[R0,#0]
  507 0000023E 438A            BICS             R2,R2,R1
  508 00000240 6002            STR              R2,[R0,#0]
  509 00000242         
  510 00000242         ;Enable clock for UART0 module     
  511 00000242 48D9            LDR              R0,=SIM_SCGC4
  512 00000244 49D9            LDR              R1,=SIM_SCGC4_UART0_MASK
  513 00000246 6802            LDR              R2,[R0,#0]
  514 00000248 430A            ORRS             R2,R2,R1
  515 0000024A 6002            STR              R2,[R0,#0]
  516 0000024C         
  517 0000024C         ;Enable clock for Port A module     
  518 0000024C 48D8            LDR              R0,=SIM_SCGC5
  519 0000024E 49D9            LDR              R1,=SIM_SCGC5_PORTA_MASK
  520 00000250 6802            LDR              R2,[R0,#0]
  521 00000252 430A            ORRS             R2,R2,R1
  522 00000254 6002            STR              R2,[R0,#0]
  523 00000256         
  524 00000256         ;Connect PORT A Pin 1 (PTA1) to UART0 Rx (J1 Pin 02)     
  525 00000256 48D8            LDR              R0,=PORTA_PCR1
  526 00000258 49D8            LDR              R1,=PORT_PCR_SET_PTA1_UART0_RX
  527 0000025A 6001            STR              R1,[R0,#0]
  528 0000025C         
  529 0000025C         ;Connect PORT A Pin 2 (PTA2) to UART0 Tx (J1 Pin 04)     
  530 0000025C 48D8            LDR              R0,=PORTA_PCR2
  531 0000025E 49D7            LDR              R1,=PORT_PCR_SET_PTA2_UART0_TX
  532 00000260 6001            STR              R1,[R0,#0]
  533 00000262         
  534 00000262         ;Disable UART0 receiver and transmitter     
  535 00000262 48D8            LDR              R0,=UART0_BASE
  536 00000264 210C            MOVS             R1,#UART0_C2_T_R
  537 00000266 78C2            LDRB             R2,[R0,#UART0_C2_OFFSET]
  538 00000268 438A            BICS             R2,R2,R1
  539 0000026A 70C2            STRB             R2,[R0,#UART0_C2_OFFSET]
  540 0000026C         
  541 0000026C         ;Set UART0 IRQ priority



ARM Macro Assembler    Page 17 CMPE 250 Exercise Twelve


  542 0000026C 48D6            LDR              R0,=UART0_IPR
  543 0000026E 4AD7            LDR              R2,=NVIC_IPR_UART0_PRI_3
  544 00000270 6803            LDR              R3,[R0,#0]
  545 00000272 4313            ORRS             R3,R3,R2
  546 00000274 6003            STR              R3,[R0,#0]
  547 00000276         
  548 00000276         ;Clear any pending UART0 interrupts
  549 00000276 48D6            LDR              R0,=NVIC_ICPR
  550 00000278 49D6            LDR              R1,=NVIC_ICPR_UART0_MASK
  551 0000027A 6001            STR              R1,[R0,#0]
  552 0000027C         
  553 0000027C         ;Unmask UART0 interrupts
  554 0000027C 48D6            LDR              R0,=NVIC_ISER
  555 0000027E 49D5            LDR              R1,=NVIC_ISER_UART0_MASK
  556 00000280 6001            STR              R1,[R0,#0]
  557 00000282         
  558 00000282         ;Set UART0 for 9600 baud, 8N1 protocol   
  559 00000282 48D0            LDR              R0,=UART0_BASE
  560 00000284 2101            MOVS             R1,#UART0_BDH_9600
  561 00000286 7001            STRB             R1,[R0,#UART0_BDH_OFFSET]
  562 00000288 2138            MOVS             R1,#UART0_BDL_9600
  563 0000028A 7041            STRB             R1,[R0,#UART0_BDL_OFFSET]
  564 0000028C 2100            MOVS             R1,#UART0_C1_8N1
  565 0000028E 7081            STRB             R1,[R0,#UART0_C1_OFFSET]
  566 00000290 2100            MOVS             R1,#UART0_C3_NO_TXINV
  567 00000292 7181            STRB             R1,[R0,#UART0_C3_OFFSET]
  568 00000294 210F            MOVS             R1,#UART0_C4_NO_MATCH_OSR_16
  569 00000296 7281            STRB             R1,[R0,#UART0_C4_OFFSET]
  570 00000298 2100            MOVS             R1,#UART0_C5_NO_DMA_SSR_SYNC
  571 0000029A 72C1            STRB             R1,[R0,#UART0_C5_OFFSET]
  572 0000029C 211F            MOVS             R1,#UART0_S1_CLEAR_FLAGS
  573 0000029E 7101            STRB             R1,[R0,#UART0_S1_OFFSET]
  574 000002A0 21C0            MOVS             R1,#UART0_S2_NO_RXINV_BRK10_NO_LBKDETECT_CLEAR_FLAGS
  575 000002A2 7141            STRB             R1,[R0,#UART0_S2_OFFSET]
  576 000002A4         
  577 000002A4         ;Enable UART0 receiver and transmitter     
  578 000002A4 212C            MOVS             R1,#UART0_C2_T_RI
  579 000002A6 70C1            STRB             R1,[R0,#UART0_C2_OFFSET]
  580 000002A8         
  581 000002A8         ;Pops R0-R3 and PC off the stack
  582 000002A8 BD0F            POP              {R0-R3,PC}
  583 000002AA                 ENDP



ARM Macro Assembler    Page 18 CMPE 250 Exercise Twelve


  584 000002AA         
  585 000002AA         UART0_ISR
                               PROC             {R0-R13}
  586 000002AA         ;Purpose:  Handles any interrupts that occur
  587 000002AA         ;   while the program is running
  588 000002AA         ;Calls:  Enqueue,Dequeue
  589 000002AA         ;Inputs: 
  590 000002AA         ;Outputs: 
  591 000002AA         ;Modified: 
  592 000002AA B672            CPSID            I
  593 000002AC B500            PUSH             {LR}
  594 000002AE 49C5            LDR              R1,=UART0_BASE
  595 000002B0         
  596 000002B0         ;If TxInterruptEnabled
  597 000002B0 2280            MOVS             R2,#UART0_C2_TIE_MASK
  598 000002B2 78C8            LDRB             R0,[R1,#UART0_C2_OFFSET]
  599 000002B4 4210            TST              R0,R2
  600 000002B6 D00C            BEQ              ISRDeq
  601 000002B8         
  602 000002B8         ;if TxInterrupt
  603 000002B8 2280            MOVS             R2,#UART0_S1_TDRE_MASK
  604 000002BA 7908            LDRB             R0,[R1,#UART0_S1_OFFSET]
  605 000002BC 4210            TST              R0,R2
  606 000002BE D008            BEQ              ISRDeq
  607 000002C0         
  608 000002C0         ;Dequeue character from TxQueue
  609 000002C0 49B3            LDR              R1,=TxQRecord
  610 000002C2 F7FF FFFE       BL               Dequeue
  611 000002C6 49BF            LDR              R1,=UART0_BASE
  612 000002C8 D201            BCS              ISRDisable
  613 000002CA         
  614 000002CA         ;Write character to UART0 transmit data reg.
  615 000002CA 71C8            STRB             R0,[R1,#UART0_D_OFFSET]
  616 000002CC E001            B                ISRDeq
  617 000002CE         
  618 000002CE         ISRDisable                           ;disable TxInterrupt
  619 000002CE 202C            MOVS             R0,#UART0_C2_T_RI
  620 000002D0 70C8            STRB             R0,[R1,#UART0_C2_OFFSET]
  621 000002D2         
  622 000002D2         ;if RxInterrupt
  623 000002D2 2220    ISRDeq  MOVS             R2,#UART0_S1_RDRF_MASK
  624 000002D4 7908            LDRB             R0,[R1,#UART0_S1_OFFSET]



ARM Macro Assembler    Page 19 CMPE 250 Exercise Twelve


  625 000002D6 4210            TST              R0,R2
  626 000002D8 D003            BEQ              ISREnd
  627 000002DA         
  628 000002DA 79C8            LDRB             R0,[R1,#UART0_D_OFFSET]
  629 000002DC 49A9            LDR              R1,=RxQRecord
  630 000002DE F7FF FFFE       BL               Enqueue
  631 000002E2         
  632 000002E2 B662    ISREnd  CPSIE            I
  633 000002E4 BD00            POP              {PC}
  634 000002E6                 ENDP
  635 000002E6         
  636 000002E6         Init_PIT_IRQ
                               PROC             {R0-R13}
  637 000002E6         ;Purpose:  Initializes the PIT for interrupts
  638 000002E6         ;Inputs: 
  639 000002E6         ;Outputs: 
  640 000002E6         ;Modified: R14-R15,APSR
  641 000002E6         
  642 000002E6         ;Pushes R0-R2 onto the stack
  643 000002E6 B407            PUSH             {R0-R2}
  644 000002E8         
  645 000002E8         ;Set SIM_CGC6 for PIT Clock Enabled
  646 000002E8 48BE            LDR              R0,=SIM_SCGC6
  647 000002EA 49BF            LDR              R1,=SIM_SCGC6_PIT_MASK
  648 000002EC 6802            LDR              R2,[R0,#0]  ;current SIM_SCGC6 value
  649 000002EE 430A            ORRS             R2,R2,R1    ;only PIT bit set
  650 000002F0 6002            STR              R2,[R0,#0]  ;update SIM_SCGC6
  651 000002F2         
  652 000002F2         ;Disable PIT timer 0
  653 000002F2 48BE            LDR              R0,=PIT_CH0_BASE
  654 000002F4 49BE            LDR              R1,=PIT_TCTRL_TEN_MASK
  655 000002F6 6882            LDR              R2,[R0,#PIT_TCTRL_OFFSET]
  656 000002F8 438A            BICS             R2,R2,R1
  657 000002FA 6082            STR              R2,[R0,#PIT_TCTRL_OFFSET]
  658 000002FC         
  659 000002FC         ;Set PIT interrupt priority
  660 000002FC 48BD            LDR              R0,=PIT_IPR
  661 000002FE 49BE            LDR              R1,=(NVIC_IPR_PIT_MASK)
  662 00000300 6802            LDR              R2,[R0,#0]
  663 00000302 438A            BICS             R2,R2,R1
  664 00000304 6002            STR              R2,[R0,#0]
  665 00000306         



ARM Macro Assembler    Page 20 CMPE 250 Exercise Twelve


  666 00000306         ;Clear any pending PIT interrupts
  667 00000306 48B2            LDR              R0,=NVIC_ICPR
  668 00000308 49BC            LDR              R1,=NVIC_ICPR_PIT_MASK
  669 0000030A 6001            STR              R1,[R0,#0]
  670 0000030C         
  671 0000030C         ;Unmask PIT interrupts
  672 0000030C 48B2            LDR              R0,=NVIC_ISER
  673 0000030E 49BB            LDR              R1,=NVIC_ISER_PIT_MASK
  674 00000310 6001            STR              R1,[R0,#0]
  675 00000312         
  676 00000312         ;Enable PIT timer module
  677 00000312 48BB            LDR              R0,=PIT_BASE
  678 00000314 49B6            LDR              R1,=PIT_MCR_EN_FRZ
  679 00000316 6001            STR              R1,[R0,#PIT_MCR_OFFSET]
  680 00000318         
  681 00000318         ;Set PIT timer 0 period for 0.01 s
  682 00000318 48B4            LDR              R0,=PIT_CH0_BASE
  683 0000031A 49BA            LDR              R1,=PIT_LDVAL_10ms
  684 0000031C 6001            STR              R1,[R0,#PIT_LDVAL_OFFSET]
  685 0000031E         
  686 0000031E         ;Enable PIT timer channel 0 for interrupts
  687 0000031E 49BA            LDR              R1,=PIT_TCTRL_CH_IE
  688 00000320 6081            STR              R1,[R0,#PIT_TCTRL_OFFSET]
  689 00000322         
  690 00000322         ;Pops R0-R2 off the stack
  691 00000322 BC07            POP              {R0-R2}
  692 00000324 4770            BX               LR
  693 00000326                 ENDP
  694 00000326         
  695 00000326         PIT_ISR PROC             {R0-R13}
  696 00000326         ;Purpose:  Handles any PIT interrupts that occur
  697 00000326         ;   while the program is running
  698 00000326         ;Inputs: 
  699 00000326         ;Outputs: 
  700 00000326         ;Modified: 
  701 00000326 B672            CPSID            I
  702 00000328 B407            PUSH             {R0-R2}
  703 0000032A         
  704 0000032A         ;If (RunStopWatch)
  705 0000032A 48AC            LDR              R0,=RunStopWatch
  706 0000032C 6800            LDR              R0,[R0,#0]
  707 0000032E 2800            CMP              R0,#0



ARM Macro Assembler    Page 21 CMPE 250 Exercise Twelve


  708 00000330 D003            BEQ              PITSkip
  709 00000332         
  710 00000332         ;Increment Count
  711 00000332 49AB            LDR              R1,=Count
  712 00000334 680A            LDR              R2,[R1,#0]
  713 00000336 1C52            ADDS             R2,R2,#1
  714 00000338 600A            STR              R2,[R1,#0]
  715 0000033A         
  716 0000033A         ;Clear any pending PIT interrupts
  717 0000033A 48AC    PITSkip LDR              R0,=PIT_CH0_BASE
  718 0000033C 49AC            LDR              R1,=PIT_TFLG_TIF_MASK
  719 0000033E 60C1            STR              R1,[R0,#PIT_TFLG_OFFSET]
  720 00000340         
  721 00000340 B662            CPSIE            I
  722 00000342 BC07            POP              {R0-R2}
  723 00000344 4770            BX               LR
  724 00000346                 ENDP
  725 00000346         
  726 00000346         Init_LED
                               PROC             {R0-R14}
  727 00000346         ;Purpose:  
  728 00000346         ;Calls:  
  729 00000346         ;Inputs: 
  730 00000346         ;Outputs: 
  731 00000346         ;Modified: 
  732 00000346 B407            PUSH             {R0-R2}
  733 00000348         
  734 00000348         ;Enable clock for PORT D and E modules
  735 00000348 4899            LDR              R0,=SIM_SCGC5
  736 0000034A 49B2            LDR              R1,=(SIM_SCGC5_PORTD_MASK :OR: SIM_SCGC5_PORTE_MASK)
  737 0000034C 6802            LDR              R2,[R0,#0]
  738 0000034E 430A            ORRS             R2,R2,R1
  739 00000350 6002            STR              R2,[R0,#0]
  740 00000352         
  741 00000352         ;Select PORT E Pin 29 for GPIO to red LED
  742 00000352 48B1            LDR              R0,=PORTE_BASE
  743 00000354 49B1            LDR              R1,=SET_PTE29_GPIO
  744 00000356 6741            STR              R1,[R0,#PORTE_PCR29_OFFSET]
  745 00000358         
  746 00000358         ;Select PORT D Pin 5 for GPIO to green LED
  747 00000358 48B1            LDR              R0,=PORTD_BASE
  748 0000035A 49B0            LDR              R1,=SET_PTD5_GPIO



ARM Macro Assembler    Page 22 CMPE 250 Exercise Twelve


  749 0000035C 6141            STR              R1,[R0,#PORTD_PCR5_OFFSET]
  750 0000035E         
  751 0000035E         ;Select data direction to output for red LED
  752 0000035E 48B1            LDR              R0,=FGPIOD_BASE
  753 00000360 49B1            LDR              R1,=LED_PORTD_MASK
  754 00000362 6141            STR              R1,[R0,#GPIO_PDDR_OFFSET]
  755 00000364         
  756 00000364         ;Select data direction to output for green LED
  757 00000364 48B1            LDR              R0,=FGPIOE_BASE
  758 00000366 49B2            LDR              R1,=LED_PORTE_MASK
  759 00000368 6141            STR              R1,[R0,#GPIO_PDDR_OFFSET]
  760 0000036A         
  761 0000036A BC07            POP              {R0-R2}
  762 0000036C 4770            BX               LR
  763 0000036E                 ENDP
  764 0000036E         
  765 0000036E         RedEnable
                               PROC             {R0-R14}
  766 0000036E         ;Purpose:  Enables the red LED
  767 0000036E         ;Calls:  
  768 0000036E         ;Inputs: 
  769 0000036E         ;Outputs: 
  770 0000036E         ;Modified: 
  771 0000036E B403            PUSH             {R0-R1}
  772 00000370         
  773 00000370 48AE            LDR              R0,=FGPIOE_BASE
  774 00000372 49AF            LDR              R1,=LED_RED_MASK
  775 00000374 6081            STR              R1,[R0,#GPIO_PCOR_OFFSET]
  776 00000376         
  777 00000376 BC03            POP              {R0-R1}
  778 00000378 4770            BX               LR
  779 0000037A                 ENDP
  780 0000037A         
  781 0000037A         RedDisable
                               PROC             {R0-R14}
  782 0000037A         ;Purpose:  Disables the red LED
  783 0000037A         ;Calls:  
  784 0000037A         ;Inputs: 
  785 0000037A         ;Outputs: 
  786 0000037A         ;Modified: 
  787 0000037A B403            PUSH             {R0-R1}
  788 0000037C         



ARM Macro Assembler    Page 23 CMPE 250 Exercise Twelve


  789 0000037C 48AB            LDR              R0,=FGPIOE_BASE
  790 0000037E 49AC            LDR              R1,=LED_RED_MASK
  791 00000380 6041            STR              R1,[R0,#GPIO_PSOR_OFFSET]
  792 00000382         
  793 00000382 BC03            POP              {R0-R1}
  794 00000384 4770            BX               LR
  795 00000386                 ENDP
  796 00000386         
  797 00000386         GreenEnable
                               PROC             {R0-R14}
  798 00000386         ;Purpose:  Enables the green LED
  799 00000386         ;Calls:  
  800 00000386         ;Inputs: 
  801 00000386         ;Outputs: 
  802 00000386         ;Modified: 
  803 00000386 B403            PUSH             {R0-R1}
  804 00000388         
  805 00000388 48A6            LDR              R0,=FGPIOD_BASE
  806 0000038A 49A7            LDR              R1,=LED_GREEN_MASK
  807 0000038C 6081            STR              R1,[R0,#GPIO_PCOR_OFFSET]
  808 0000038E         
  809 0000038E BC03            POP              {R0-R1}
  810 00000390 4770            BX               LR
  811 00000392                 ENDP
  812 00000392         
  813 00000392         GreenDisable
                               PROC             {R0-R14}
  814 00000392         ;Purpose:  Disables the green LED
  815 00000392         ;Calls:  
  816 00000392         ;Inputs: 
  817 00000392         ;Outputs: 
  818 00000392         ;Modified: 
  819 00000392 B403            PUSH             {R0-R1}
  820 00000394         
  821 00000394 48A3            LDR              R0,=FGPIOD_BASE
  822 00000396 49A4            LDR              R1,=LED_GREEN_MASK
  823 00000398 6041            STR              R1,[R0,#GPIO_PSOR_OFFSET]
  824 0000039A         
  825 0000039A BC03            POP              {R0-R1}
  826 0000039C 4770            BX               LR
  827 0000039E                 ENDP
  828 0000039E         



ARM Macro Assembler    Page 24 CMPE 250 Exercise Twelve


  829 0000039E         RandomGen
                               PROC             {R0-R14}
  830 0000039E         ;Purpose:  Generates a random number from 0-3 based on 
  831 0000039E         ;   the least significant bit of the PIT timer
  832 0000039E         ;Calls:  DIVU
  833 0000039E         ;Inputs: 
  834 0000039E         ;Outputs: R3 - number between 0-3
  835 0000039E         ;Modified: 
  836 0000039E B507            PUSH             {R0-R2,LR}
  837 000003A0         
  838 000003A0 498F            LDR              R1,=Count
  839 000003A2 6809            LDR              R1,[R1,#0]  ;Load count value into R1
  840 000003A4 2203            MOVS             R2,#0x00000003 ;Create ANDS mask to isolate LSB of Count
  841 000003A6 4011            ANDS             R1,R1,R2    ;Isolate least significant bit of Count
  842 000003A8         ;MOVS R0,#4    ;Load 4 into R0
  843 000003A8         ;BL  DIVU    ;Divide LSB of Count by 4, resulting in a number from 0-3
  844 000003A8 000B            MOVS             R3,R1       ;Move number into R3 for main code
  845 000003AA         
  846 000003AA BD07            POP              {R0-R2,PC}
  847 000003AC                 ENDP
  848 000003AC         
  849 000003AC         GetInput
                               PROC             {R1-R14}
  850 000003AC         ;Purpose: Waits for time to expire for the round 
  851 000003AC         ;   or for the user to enter their answer.
  852 000003AC         ;Calls:  
  853 000003AC         ;Inputs:  R2 - Round Number
  854 000003AC         ;Outputs:  R0 - answer to the game
  855 000003AC         ;Modifies: R0
  856 000003AC B5FE            PUSH             {R1-R7,LR}
  857 000003AE         
  858 000003AE         ;get round time limit
  859 000003AE 2664            MOVS             R6,#100
  860 000003B0 0017            MOVS             R7,R2       ;R7 = Round number
  861 000003B2 250B            MOVS             R5,#11
  862 000003B4 1BEF            SUBS             R7,R5,R7    ;R7 = 11 - Round Number
  863 000003B6 4377            MULS             R7,R6,R7    ;R7 = R7 * 100 (convert to scale of 0.01s)
  864 000003B8         
  865 000003B8         ;getting access to the queue
  866 000003B8 4E72            LDR              R6,=RxQRecord
  867 000003BA         
  868 000003BA B662            CPSIE            I



ARM Macro Assembler    Page 25 CMPE 250 Exercise Twelve


  869 000003BC         
  870 000003BC         GetInputLoop
  871 000003BC         
  872 000003BC         ;did they hit a key
  873 000003BC 7C75            LDRB             R5,[R6,#NUM_ENQD]
  874 000003BE 2D00            CMP              R5,#0
  875 000003C0 D105            BNE              StopTimer   ;if yes, stop the timer
  876 000003C2         
  877 000003C2         ;do they still have time
  878 000003C2 4B87            LDR              R3,=Count
  879 000003C4 681B            LDR              R3,[R3,#0]
  880 000003C6 42BB            CMP              R3,R7
  881 000003C8 DBF8            BLT              GetInputLoop ;if yes, check again to see if they have entered anything
  882 000003CA 2000            MOVS             R0,#0       ;Load zero into R0 to indicate no input
  883 000003CC E001            B                NoInput
  884 000003CE         
  885 000003CE         StopTimer
  886 000003CE         
  887 000003CE         ;CPSID I
  888 000003CE         
  889 000003CE         ;stop the timer
  890 000003CE         ;LDR     R2,=RunStopWatch
  891 000003CE         ;MOVS R1,#0
  892 000003CE         ;STRB    R1,[R2,#0]
  893 000003CE         
  894 000003CE F7FF FFFE       BL               GetChar
  895 000003D2         
  896 000003D2         NoInput
  897 000003D2 BDFE            POP              {R1-R7,PC}
  898 000003D4                 ENDP
  899 000003D4         
  900 000003D4         ComputeScore
                               PROC             {R0-R14}
  901 000003D4         ;Purpose:  Computes the new current score, by adding
  902 000003D4         ;   together the previous score, the current
  903 000003D4         ;   round number squared, and the number of 
  904 000003D4         ;   seconds left in the current round.
  905 000003D4         ;Calls:  
  906 000003D4         ;Inputs: R2 - Round number
  907 000003D4         ;Outputs: 
  908 000003D4         ;Modified: 
  909 000003D4 B51F            PUSH             {R0-R4,LR}



ARM Macro Assembler    Page 26 CMPE 250 Exercise Twelve


  910 000003D6         
  911 000003D6 4B8D            LDR              R3,=Score
  912 000003D8 681C            LDR              R4,[R3,#0]  ;Load Score into R4
  913 000003DA 4981            LDR              R1,=Count
  914 000003DC 6809            LDR              R1,[R1,#0]  ;Load Count into R1
  915 000003DE         
  916 000003DE 4352            MULS             R2,R2,R2    ;Square the round #
  917 000003E0 18A4            ADDS             R4,R4,R2    ;Add round^2 to Score
  918 000003E2         
  919 000003E2 2064            MOVS             R0,#100
  920 000003E4 F7FF FFFE       BL               DIVU        ;Count = Count/100
  921 000003E8 0001            MOVS             R1,R0
  922 000003EA         ;MOVS R0,#10
  923 000003EA         ;BL  DIVU    ;Count = Count/1000
  924 000003EA         ;MOVS R1,R0
  925 000003EA         
  926 000003EA 200B            MOVS             R0,#11
  927 000003EC 1A41            SUBS             R1,R0,R1    ;Time left = 11 - Count
  928 000003EE 1864            ADDS             R4,R4,R1    ;Add seconds remaining to Score
  929 000003F0         
  930 000003F0 601C            STR              R4,[R3,#0]  ;Store back Score
  931 000003F2 BD1F            POP              {R0-R4,PC}
  932 000003F4                 ENDP
  933 000003F4         
  934 000003F4         GetChar PROC             {R1-R13}
  935 000003F4         ;Purpose:  Reads a single character from
  936 000003F4         ;   the terminal keyboard into R0
  937 000003F4         ;Calls:  Dequeue
  938 000003F4         ;Inputs: 
  939 000003F4         ;Outputs: 
  940 000003F4         ;Modified: R0,R14-R15,APSR
  941 000003F4         
  942 000003F4         ;Pushes R1 and LR onto the stack
  943 000003F4 B502            PUSH             {R1,LR}
  944 000003F6         
  945 000003F6 4963            LDR              R1,=RxQRecord
  946 000003F8         
  947 000003F8         ;Mask other interrupts    
  948 000003F8 B672    GetLoop CPSID            I
  949 000003FA         
  950 000003FA         ;Dequeue character from RxQueue
  951 000003FA F7FF FFFE       BL               Dequeue



ARM Macro Assembler    Page 27 CMPE 250 Exercise Twelve


  952 000003FE         
  953 000003FE         ;Unmask other interrupts
  954 000003FE B662            CPSIE            I
  955 00000400         
  956 00000400         ;Repeat until dequeue successful
  957 00000400 D300            BLO              EndGet
  958 00000402 E7F9            B                GetLoop
  959 00000404         
  960 00000404         ;Pops R1 and PC off of the stack
  961 00000404 BD02    EndGet  POP              {R1,PC}
  962 00000406                 ENDP
  963 00000406         
  964 00000406         PutChar PROC             {R0-R13}
  965 00000406         ;Purpose:  Displays a single character in
  966 00000406         ;   R0 to the terminal screen
  967 00000406         ;Calls:  Enqueue
  968 00000406         ;Inputs: 
  969 00000406         ;Outputs: 
  970 00000406         ;Modified: R14-R15,APSR
  971 00000406         
  972 00000406         ;Pushes R0-R1 and LR onto the stack
  973 00000406 B503            PUSH             {R0-R1,LR}
  974 00000408         
  975 00000408 4961            LDR              R1,=TxQRecord
  976 0000040A         
  977 0000040A         ;Mask other interrupts    
  978 0000040A B672    PutLoop CPSID            I
  979 0000040C         
  980 0000040C         ;Enqueue character
  981 0000040C F7FF FFFE       BL               Enqueue
  982 00000410         
  983 00000410         ;Unmask other interrupts
  984 00000410 B662            CPSIE            I
  985 00000412         
  986 00000412         ;Repeat until enqueue successful
  987 00000412 D300            BLO              EndPut
  988 00000414 E7F9            B                PutLoop
  989 00000416         
  990 00000416         ;Enable TxInterrupt
  991 00000416 486B    EndPut  LDR              R0,=UART0_BASE
  992 00000418 21AC            MOVS             R1,#UART0_C2_TI_RI
  993 0000041A 70C1            STRB             R1,[R0,#UART0_C2_OFFSET]



ARM Macro Assembler    Page 28 CMPE 250 Exercise Twelve


  994 0000041C         
  995 0000041C         ;Pops R0-R1 and PC off of the stack
  996 0000041C BD03            POP              {R0-R1,PC}
  997 0000041E                 ENDP
  998 0000041E         
  999 0000041E         NewLine PROC             {R0-R14}
 1000 0000041E         ;Purpose:  Print a new line and carriage return
 1001 0000041E         ;Calls:  PutChar
 1002 0000041E         ;Inputs: 
 1003 0000041E         ;Outputs: 
 1004 0000041E         ;Modified: 
 1005 0000041E B501            PUSH             {R0,LR}
 1006 00000420 200D            MOVS             R0,#13
 1007 00000422 F7FF FFFE       BL               PutChar
 1008 00000426 200A            MOVS             R0,#10
 1009 00000428 F7FF FFFE       BL               PutChar
 1010 0000042C BD01            POP              {R0,PC}
 1011 0000042E                 ENDP
 1012 0000042E         
 1013 0000042E         PutStringSB
                               PROC             {R0-R14}
 1014 0000042E         ;Purpose:  Displays a null-terminated string from memory, 
 1015 0000042E         ;    starting at the address where R0 points, to the
 1016 0000042E         ;    terminal screen, for a buffer capacity of R1.
 1017 0000042E         ;Calls:  PutChar
 1018 0000042E         ;Inputs: R0,R1
 1019 0000042E         ;Outputs: 
 1020 0000042E         ;Modified: APSR
 1021 0000042E B51F            PUSH             {R0-R4,LR}
 1022 00000430         
 1023 00000430 2300            MOVS             R3,#0       ; Initialize offset counter
 1024 00000432 0004            MOVS             R4,R0       ; R4 = *StringPtr
 1025 00000434 5CE0            LDRB             R0,[R4,R3]
 1026 00000436         
 1027 00000436 2800    PutSLoop
                               CMP              R0,#0       ; Checks if it reached end of string
 1028 00000438 D006            BEQ              EndPutS     ; While Character != 0
 1029 0000043A 428B            CMP              R3,R1       ; Compares current iteration to buffer capacity
 1030 0000043C DA04            BGE              EndPutS     ; If it goes beyond the buffer, stop
 1031 0000043E F7FF FFFE       BL               PutChar     ; Displays R0 to the terminal
 1032 00000442         
 1033 00000442 1C5B            ADDS             R3,R3,#1    ; R3++



ARM Macro Assembler    Page 29 CMPE 250 Exercise Twelve


 1034 00000444 5CE0            LDRB             R0,[R4,R3]  ; Loads next byte value
 1035 00000446 E7F6            B                PutSLoop
 1036 00000448         
 1037 00000448 BD1F    EndPutS POP              {R0-R4,PC}
 1038 0000044A                 ENDP
 1039 0000044A         
 1040 0000044A         PutNumU PROC             {R0-R14}
 1041 0000044A         ;Purpose:  Prints the decimal representation of the value
 1042 0000044A         ;   stored in R0 to the terminal screen.
 1043 0000044A         ;Calls:  DIVU
 1044 0000044A         ;Inputs: R0
 1045 0000044A         ;Outputs: 
 1046 0000044A         ;Modified: APSR
 1047 0000044A B50F            PUSH             {R0-R3,LR}
 1048 0000044C         
 1049 0000044C 0001            MOVS             R1,R0       ; Moves R0 into dividend register
 1050 0000044E 2300            MOVS             R3,#0       ; Initializes pop counter
 1051 00000450 200A    PutULoop
                               MOVS             R0,#10      ; Moves 10 into divisor register
 1052 00000452 F7FF FFFE       BL               DIVU        ; Divides R0 by 10
 1053 00000456         
 1054 00000456 0002    NotZeroU
                               MOVS             R2,R0       ; Moves quotient into R2 for later check
 1055 00000458 0008            MOVS             R0,R1       ; Moves remainder into R0 for PutChar
 1056 0000045A         
 1057 0000045A 3030            ADDS             R0,#48      ; Converts to ascii decimal number
 1058 0000045C B401            PUSH             {R0}        ; Pushes R0 onto the stack
 1059 0000045E 1C5B            ADDS             R3,R3,#1    ; R3++
 1060 00000460         
 1061 00000460 0011            MOVS             R1,R2       ; Puts quotient back into R1
 1062 00000462 2900            CMP              R1,#0       ; Checks if R0 is 1
 1063 00000464 D1F4            BNE              PutULoop    ; Loops until R1 is 0
 1064 00000466         
 1065 00000466 BC01    EndNumU POP              {R0}
 1066 00000468 F7FF FFFE       BL               PutChar
 1067 0000046C 1E5B            SUBS             R3,R3,#1
 1068 0000046E 2B00            CMP              R3,#0
 1069 00000470 D1F9            BNE              EndNumU
 1070 00000472         
 1071 00000472 BD0F            POP              {R0-R3,PC}
 1072 00000474                 ENDP
 1073 00000474         



ARM Macro Assembler    Page 30 CMPE 250 Exercise Twelve


 1074 00000474         DIVU    PROC             {R2-R14}
 1075 00000474         ;Purpose:  Performs standard integer division,
 1076 00000474         ;   dividing R1 by R0 and putting the result
 1077 00000474         ;   into R0 and the remainder in R1.
 1078 00000474         ;Inputs: R0,R1
 1079 00000474         ;Outputs: R0,R1,APSR
 1080 00000474         ;Changed: R0-R1,APSR
 1081 00000474 2800            CMP              R0,#0       ; Compares R0 to 0
 1082 00000476 D009            BEQ              ZeroDenDIVU ; If R0 = 0, branch
 1083 00000478         
 1084 00000478 B404            PUSH             {R2}
 1085 0000047A B408            PUSH             {R3}
 1086 0000047C 2200            MOVS             R2,#0       ; R2 = 0 (Result)
 1087 0000047E         
 1088 0000047E 2900            CMP              R1,#0       ; Compares R1 to 0
 1089 00000480 D00C            BEQ              EndDIVU     ; If R1 = 0, branch
 1090 00000482         
 1091 00000482 4281    WhileDIVU
                               CMP              R1,R0
 1092 00000484 D30A            BLO              EndDIVU
 1093 00000486 1A09            SUBS             R1,R1,R0    ; R1 -= R0
 1094 00000488 1C52            ADDS             R2,R2,#1    ; Result += 1
 1095 0000048A E7FA            B                WhileDIVU   ; Loop until R1-R0 < 0
 1096 0000048C         
 1097 0000048C F3EF 8000 
                       ZeroDenDIVU
                               MRS              R0,APSR     ; This whole section sets the C flag,
 1098 00000490 2120            MOVS             R1,#0x20    ; while keeping the other flags unchanged
 1099 00000492 0609            LSLS             R1,R1,#24
 1100 00000494 4308            ORRS             R0,R0,R1
 1101 00000496 F380 8800       MSR              APSR,R0
 1102 0000049A E009            B                SkipDIVU    ; Ensures nothing changes if R0 = 0
 1103 0000049C         
 1104 0000049C 0010    EndDIVU MOVS             R0,R2       ; Moves Result into R0
 1105 0000049E         
 1106 0000049E F3EF 8200       MRS              R2,APSR     ; This whole section clears the C flag,
 1107 000004A2 2320            MOVS             R3,#0x20    ; while keeping the other flags unchanged
 1108 000004A4 061B            LSLS             R3,R3,#24
 1109 000004A6 439A            BICS             R2,R2,R3
 1110 000004A8 F382 8800       MSR              APSR,R2
 1111 000004AC         
 1112 000004AC BC08            POP              {R3}



ARM Macro Assembler    Page 31 CMPE 250 Exercise Twelve


 1113 000004AE BC04            POP              {R2}
 1114 000004B0 4770    SkipDIVU
                               BX               LR
 1115 000004B2                 ENDP
 1116 000004B2         
 1117 000004B2         InitQueue
                               PROC             {R0-R14}
 1118 000004B2         ;Purpose:  Initializes the queue record structure at the 
 1119 000004B2         ;   address in R1 for the empty queue buffer at 
 1120 000004B2         ;   the address in R0 of size given in R2.
 1121 000004B2         ;Calls:  
 1122 000004B2         ;Inputs: R0,R1,R2
 1123 000004B2         ;Outputs: 
 1124 000004B2         ;Changed: 
 1125 000004B2 B407            PUSH             {R0-R2}
 1126 000004B4         
 1127 000004B4 6008            STR              R0,[R1,#IN_PTR] ; Moves queue address to InPointer
 1128 000004B6 6048            STR              R0,[R1,#OUT_PTR] ; Moves queue address to OutPointer
 1129 000004B8 6088            STR              R0,[R1,#BUF_STRT] ; Moves queue address to BufferStart
 1130 000004BA         
 1131 000004BA 1880            ADDS             R0,R0,R2    ; Adds size to queue address to obtain BufferPast
 1132 000004BC 60C8            STR              R0,[R1,#BUF_PAST] ; Moves that value to BufferPast
 1133 000004BE 740A            STRB             R2,[R1,#BUF_SIZE] ; Moves size into BufferSize
 1134 000004C0         
 1135 000004C0 2200            MOVS             R2,#0
 1136 000004C2 744A            STRB             R2,[R1,#NUM_ENQD] ; Moves 0 into NumberEnqueued
 1137 000004C4         
 1138 000004C4 BC07            POP              {R0-R2}
 1139 000004C6 4770            BX               LR
 1140 000004C8                 ENDP
 1141 000004C8         
 1142 000004C8         Dequeue PROC             {R0-R14}
 1143 000004C8         ;Purpose:  Attempts to get a character from the queue whose record 
 1144 000004C8         ;   structures address is in R1:  if the queue is not empty, 
 1145 000004C8         ;   dequeues a single character from the queue to R0, and returns 
 1146 000004C8         ;   with the PSR C bit cleared to report dequeue success; otherwise, 
 1147 000004C8         ;   returns with the PSRC bit set to report dequeue failure.
 1148 000004C8         ;Calls:  
 1149 000004C8         ;Inputs: R1
 1150 000004C8         ;Outputs: R0,APSR
 1151 000004C8         ;Changed: R0,APSR
 1152 000004C8 B40E            PUSH             {R1-R3}



ARM Macro Assembler    Page 32 CMPE 250 Exercise Twelve


 1153 000004CA         
 1154 000004CA 7C4A            LDRB             R2,[R1,#NUM_ENQD] ; Load NumberEnqueued
 1155 000004CC 2A00            CMP              R2,#0
 1156 000004CE D107            BNE              DeqSkipC    ; If queue is empty (NumberEnqueued = 0)
 1157 000004D0         
 1158 000004D0 F3EF 8100       MRS              R1,APSR     ;
 1159 000004D4 2220            MOVS             R2,#0x20    ;
 1160 000004D6 0612            LSLS             R2,R2,#24   ; Set the C flag
 1161 000004D8 4311            ORRS             R1,R1,R2    ;
 1162 000004DA F381 8800       MSR              APSR,R1     ;
 1163 000004DE         
 1164 000004DE E010            B                EndDeq
 1165 000004E0         
 1166 000004E0 1E52    DeqSkipC
                               SUBS             R2,R2,#1    ; NumberEnqueued--
 1167 000004E2 744A            STRB             R2,[R1,#NUM_ENQD]
 1168 000004E4         
 1169 000004E4 684B            LDR              R3,[R1,#OUT_PTR] ; Load memory address at OutPointer
 1170 000004E6 7818            LDRB             R0,[R3,#0]  ; Get queue item at OutPointer
 1171 000004E8         
 1172 000004E8 1C5B            ADDS             R3,R3,#1    ; Increment OutPointer
 1173 000004EA 68CA            LDR              R2,[R1,#BUF_PAST] ; Load BufferPast
 1174 000004EC 4293            CMP              R3,R2
 1175 000004EE DB00            BLT              DeqSkipP    ; If OutPointer >= BufferPast
 1176 000004F0 688B            LDR              R3,[R1,#BUF_STRT] ; Set OutPointer to BufferStart
 1177 000004F2         
 1178 000004F2 604B    DeqSkipP
                               STR              R3,[R1,#OUT_PTR] ; OutPointer = R3
 1179 000004F4         
 1180 000004F4 F3EF 8100       MRS              R1,APSR     ;
 1181 000004F8 2220            MOVS             R2,#0x20    ;
 1182 000004FA 0612            LSLS             R2,R2,#24   ; Clear the C flag
 1183 000004FC 4391            BICS             R1,R1,R2    ;
 1184 000004FE F381 8800       MSR              APSR,R1     ;
 1185 00000502         
 1186 00000502 BC0E    EndDeq  POP              {R1-R3}
 1187 00000504 4770            BX               LR
 1188 00000506                 ENDP
 1189 00000506         
 1190 00000506         Enqueue PROC             {R0-R14}
 1191 00000506         ;Purpose:  Attempts to put a character in the queue whose queue record 
 1192 00000506         ;   structures address is in R1if the queue is not full, enqueues 



ARM Macro Assembler    Page 33 CMPE 250 Exercise Twelve


 1193 00000506         ;   the single character from R0 to the queue, and returns with 
 1194 00000506         ;   the PSR C cleared to report enqueue success; otherwise, returns 
 1195 00000506         ;   with the PSR C bit set to report enqueue failure.
 1196 00000506         ;Calls:  
 1197 00000506         ;Inputs: R0,R1
 1198 00000506         ;Outputs: APSR
 1199 00000506         ;Changed: APSR
 1200 00000506 B41F            PUSH             {R0-R4}
 1201 00000508         
 1202 00000508 7C4A            LDRB             R2,[R1,#NUM_ENQD] ; Load NumberEnqueued
 1203 0000050A 7C0B            LDRB             R3,[R1,#BUF_SIZE] ; Load BufferSize
 1204 0000050C 429A            CMP              R2,R3
 1205 0000050E D107            BNE              EnqSkipC    ; If queue is full (NumberEnqueued = BufferSize)
 1206 00000510         
 1207 00000510 F3EF 8100       MRS              R1,APSR     ;
 1208 00000514 2220            MOVS             R2,#0x20    ;
 1209 00000516 0612            LSLS             R2,R2,#24   ; Set the C flag
 1210 00000518 4311            ORRS             R1,R1,R2    ;
 1211 0000051A F381 8800       MSR              APSR,R1     ;
 1212 0000051E         
 1213 0000051E E010            B                EndEnq
 1214 00000520         
 1215 00000520 1C52    EnqSkipC
                               ADDS             R2,R2,#1    ; NumberEnqueued++
 1216 00000522 744A            STRB             R2,[R1,#NUM_ENQD]
 1217 00000524         
 1218 00000524 680B            LDR              R3,[R1,#IN_PTR] ; Load memory address at InPointer
 1219 00000526 7018            STRB             R0,[R3,#0]  ; Store queue item at InPointer
 1220 00000528         
 1221 00000528 1C5B            ADDS             R3,R3,#1    ; Increment InPointer
 1222 0000052A 68CA            LDR              R2,[R1,#BUF_PAST] ; Load BufferPast
 1223 0000052C 4293            CMP              R3,R2
 1224 0000052E DB00            BLT              EnqSkipP    ; If InPointer >= BufferPast
 1225 00000530 688B            LDR              R3,[R1,#BUF_STRT] ; Set InPointer to BufferStart
 1226 00000532         
 1227 00000532 600B    EnqSkipP
                               STR              R3,[R1,#IN_PTR] ; InPointer = R3
 1228 00000534         
 1229 00000534 F3EF 8300       MRS              R3,APSR     ;
 1230 00000538 2420            MOVS             R4,#0x20    ;
 1231 0000053A 0624            LSLS             R4,R4,#24   ; Clear the C flag
 1232 0000053C 43A3            BICS             R3,R3,R4    ;



ARM Macro Assembler    Page 34 CMPE 250 Exercise Twelve


 1233 0000053E F383 8800       MSR              APSR,R3     ;
 1234 00000542         
 1235 00000542 BC1F    EndEnq  POP              {R0-R4}
 1236 00000544 4770            BX               LR
 1237 00000546                 ENDP
 1238 00000546         
 1239 00000546         PutNumHex
                               PROC             {R0-R14}
 1240 00000546         ;Purpose:  This subroutine prints to the terminal screen the text 
 1241 00000546         ;   hexadecimal representation of the unsigned word value in R0.
 1242 00000546         ;Calls:  PutChar
 1243 00000546         ;Inputs: R0
 1244 00000546         ;Outputs: 
 1245 00000546         ;Changed: 
 1246 00000546 B51F            PUSH             {R0-R4,LR}
 1247 00000548         
 1248 00000548 2100            MOVS             R1,#0       ; Initialize loop counter
 1249 0000054A 220F            MOVS             R2,#0x0000000F ; Create ANDS mask to apply after shift
 1250 0000054C         
 1251 0000054C 0003    PutHLoop
                               MOVS             R3,R0       ; Copy R0 into R3
 1252 0000054E         
 1253 0000054E 40CB            LSRS             R3,R3,R1    ; Shift right R1 times
 1254 00000550 4013            ANDS             R3,R3,R2    ; Isolate least significant bit of R3
 1255 00000552         
 1256 00000552 2B09            CMP              R3,#9
 1257 00000554 DC01            BGT              PutHHex     ; If R3 <= 9 (decimal number)
 1258 00000556 3330            ADDS             R3,R3,#48   ; Convert to ASCII
 1259 00000558 E000            B                PutHPrint
 1260 0000055A 3337    PutHHex ADDS             R3,R3,#55   ; Convert to ASCII
 1261 0000055C         
 1262 0000055C B408    PutHPrint
                               PUSH             {R3}        ; Push the value onto the stack
 1263 0000055E         
 1264 0000055E 1D09            ADDS             R1,R1,#4    ; R1 = R1 + 4
 1265 00000560 291D            CMP              R1,#29      ; Check if it's gone through every bit
 1266 00000562 DBF3            BLT              PutHLoop    ; Loop until it has
 1267 00000564         
 1268 00000564 BC01    PutPopLoop
                               POP              {R0}
 1269 00000566 F7FF FFFE       BL               PutChar     ; Print value to terminal
 1270 0000056A 1F09            SUBS             R1,R1,#4    ; R1 = R1 - 4



ARM Macro Assembler    Page 35 CMPE 250 Exercise Twelve


 1271 0000056C 2900            CMP              R1,#0
 1272 0000056E D1F9            BNE              PutPopLoop
 1273 00000570         
 1274 00000570 BD1F            POP              {R0-R4,PC}
 1275 00000572                 ENDP
 1276 00000572         
 1277 00000572         PutNumUB
                               PROC             {R0-R14}
 1278 00000572         ;Purpose:  This subroutine prints to the terminal screen the text 
 1279 00000572         ;   decimal representation of the unsigned byte value in R0.  
 1280 00000572         ;Calls:  PutNumU
 1281 00000572         ;Inputs: R0
 1282 00000572         ;Outputs: 
 1283 00000572         ;Changed: 
 1284 00000572 B503            PUSH             {R0-R1,LR}
 1285 00000574         
 1286 00000574 21FF            MOVS             R1,#0x000000FF ; Create ANDS mask to isolate byte
 1287 00000576 4008            ANDS             R0,R0,R1    ; Clears all but least significant byte
 1288 00000578 F7FF FFFE       BL               PutNumU
 1289 0000057C         
 1290 0000057C BD03            POP              {R0-R1,PC}
 1291 0000057E                 ENDP
 1292 0000057E         ; >>>>>   end subroutine code <<<<<
 1293 0000057E 00 00           ALIGN
 1294 00000580         ;****************************************************************
 1295 00000580         ;Vector Table Mapped to Address 0 at Reset
 1296 00000580         ;Linker requires __Vectors to be exported
 1297 00000580 00000000 
              00000000 
              00000050 
              00000000 
              00000000 
              40048004 
              0C000000 
              04010000 
              40048010 
              00010007 
              40048034 
              00000400 
              40048038 
              00000200 
              40049004 



ARM Macro Assembler    Page 36 CMPE 250 Exercise Twelve


              01000200 
              40049008 
              4006A000 
              E000E40C 
              000000C0 
              E000E280 
              00001000 
              E000E100 
              00000000 
              00000000 
              4004803C 
              00800000 
              40037100 
              00000001 
              E000E414 
              00C00000 
              00400000 
              40037000 
              0003A97F 
              00000003 
              00000000 
              00000000 
              00003000 
              4004D000 
              01000100 
              4004C000 
              F80FF0C0 
              00000020 
              F80FF100 
              20000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000         AREA             RESET, DATA, READONLY
 1298 00000000                 EXPORT           __Vectors
 1299 00000000                 EXPORT           __Vectors_End
 1300 00000000                 EXPORT           __Vectors_Size
 1301 00000000                 IMPORT           __initial_sp
 1302 00000000                 IMPORT           Dummy_Handler



ARM Macro Assembler    Page 37 CMPE 250 Exercise Twelve


 1303 00000000                 IMPORT           HardFault_Handler
 1304 00000000         __Vectors
 1305 00000000         ;ARM core vectors
 1306 00000000 00000000        DCD              __initial_sp ;00:end of stack
 1307 00000004 00000000        DCD              Reset_Handler ;01:reset vector
 1308 00000008 00000000        DCD              Dummy_Handler ;02:NMI
 1309 0000000C 00000000        DCD              HardFault_Handler ;03:hard fault
 1310 00000010 00000000        DCD              Dummy_Handler ;04:(reserved)
 1311 00000014 00000000        DCD              Dummy_Handler ;05:(reserved)
 1312 00000018 00000000        DCD              Dummy_Handler ;06:(reserved)
 1313 0000001C 00000000        DCD              Dummy_Handler ;07:(reserved)
 1314 00000020 00000000        DCD              Dummy_Handler ;08:(reserved)
 1315 00000024 00000000        DCD              Dummy_Handler ;09:(reserved)
 1316 00000028 00000000        DCD              Dummy_Handler ;10:(reserved)
 1317 0000002C 00000000        DCD              Dummy_Handler ;11:SVCall (supervisor call)
 1318 00000030 00000000        DCD              Dummy_Handler ;12:(reserved)
 1319 00000034 00000000        DCD              Dummy_Handler ;13:(reserved)
 1320 00000038 00000000        DCD              Dummy_Handler ;14:PendableSrvReq (pendable request 
 1321 0000003C         ;   for system service)
 1322 0000003C 00000000        DCD              Dummy_Handler ;15:SysTick (system tick timer)
 1323 00000040 00000000        DCD              Dummy_Handler ;16:DMA channel 0 xfer complete/error
 1324 00000044 00000000        DCD              Dummy_Handler ;17:DMA channel 1 xfer complete/error
 1325 00000048 00000000        DCD              Dummy_Handler ;18:DMA channel 2 xfer complete/error
 1326 0000004C 00000000        DCD              Dummy_Handler ;19:DMA channel 3 xfer complete/error
 1327 00000050 00000000        DCD              Dummy_Handler ;20:(reserved)
 1328 00000054 00000000        DCD              Dummy_Handler ;21:command complete; read collision
 1329 00000058 00000000        DCD              Dummy_Handler ;22:low-voltage detect;
 1330 0000005C         ;   low-voltage warning
 1331 0000005C 00000000        DCD              Dummy_Handler ;23:low leakage wakeup
 1332 00000060 00000000        DCD              Dummy_Handler ;24:I2C0
 1333 00000064 00000000        DCD              Dummy_Handler ;25:I2C1
 1334 00000068 00000000        DCD              Dummy_Handler ;26:SPI0 (all IRQ sources)
 1335 0000006C 00000000        DCD              Dummy_Handler ;27:SPI1 (all IRQ sources)
 1336 00000070 00000000        DCD              UART0_ISR   ;28:UART0 (status; error)
 1337 00000074 00000000        DCD              Dummy_Handler ;29:UART1 (status; error)
 1338 00000078 00000000        DCD              Dummy_Handler ;30:UART2 (status; error)
 1339 0000007C 00000000        DCD              Dummy_Handler ;31:ADC0
 1340 00000080 00000000        DCD              Dummy_Handler ;32:CMP0
 1341 00000084 00000000        DCD              Dummy_Handler ;33:TPM0
 1342 00000088 00000000        DCD              Dummy_Handler ;34:TPM1
 1343 0000008C 00000000        DCD              Dummy_Handler ;35:TPM2
 1344 00000090 00000000        DCD              Dummy_Handler ;36:RTC (alarm)



ARM Macro Assembler    Page 38 CMPE 250 Exercise Twelve


 1345 00000094 00000000        DCD              Dummy_Handler ;37:RTC (seconds)
 1346 00000098 00000000        DCD              PIT_ISR     ;38:PIT (all IRQ sources)
 1347 0000009C 00000000        DCD              Dummy_Handler ;39:I2S0
 1348 000000A0 00000000        DCD              Dummy_Handler ;40:USB0
 1349 000000A4 00000000        DCD              Dummy_Handler ;41:DAC0
 1350 000000A8 00000000        DCD              Dummy_Handler ;42:TSI0
 1351 000000AC 00000000        DCD              Dummy_Handler ;43:MCG
 1352 000000B0 00000000        DCD              Dummy_Handler ;44:LPTMR0
 1353 000000B4 00000000        DCD              Dummy_Handler ;45:Segment LCD
 1354 000000B8 00000000        DCD              Dummy_Handler ;46:PORTA pin detect
 1355 000000BC 00000000        DCD              Dummy_Handler ;47:PORTC and PORTD pin detect
 1356 000000C0         __Vectors_End
 1357 000000C0 000000C0 
                       __Vectors_Size
                               EQU              __Vectors_End - __Vectors
 1358 000000C0                 ALIGN
 1359 000000C0         ;****************************************************************
 1360 000000C0         ;Constants
 1361 000000C0                 AREA             MyConst,DATA,READONLY
 1362 00000000         ;>>>>> begin constants here <<<<<
 1363 00000000 57 65 6C 
              63 6F 6D 
              65 20 74 
              6F 20 74 
              68 65 20 
              53 75 70 
              65 72 20 
              46 75 6E 
              20 44 65 
              6C 75 78 
              65 20 4C 
              45 44 20 
              46 75 6E 
              20 47 61 
              6D 65 28 
              54 4D 29 
              21 00    Welcome DCB              "Welcome to the Super Fun Deluxe LED Fun Game(TM)!", 0
 1364 00000032 54 68 65 
              20 67 61 
              6D 65 20 
              69 73 20 
              73 70 6C 



ARM Macro Assembler    Page 39 CMPE 250 Exercise Twelve


              69 74 20 
              69 6E 74 
              6F 20 31 
              30 20 72 
              6F 75 6E 
              64 73 2C 
              20 61 6E 
              64 20 66 
              6F 72 20 
              65 61 63 
              68 20 72 
              6F 75 6E 
              64 2C 00 Instruct1
                               DCB              "The game is split into 10 rounds, and for each round,", 0
 1365 00000068 79 6F 75 
              20 72 65 
              66 65 72 
              20 74 6F 
              20 74 68 
              65 20 62 
              6F 61 72 
              64 20 61 
              6E 64 20 
              73 65 65 
              20 77 68 
              69 63 68 
              20 4C 45 
              44 73 20 
              61 72 65 
              20 6C 69 
              74 20 75 
              70 2E 00 Instruct2
                               DCB              "you refer to the board and see which LEDs are lit up.", 0
 1366 0000009E 59 6F 75 
              20 74 68 
              65 6E 20 
              74 79 70 
              65 20 74 
              68 65 20 
              63 68 61 
              72 61 63 
              74 65 72 



ARM Macro Assembler    Page 40 CMPE 250 Exercise Twelve


              20 63 6F 
              72 72 65 
              73 70 6F 
              6E 64 69 
              6E 67 20 
              74 6F 20 
              74 68 65 
              20 4C 45 
              44 28 73 
              29 2E 00 Instruct3
                               DCB              "You then type the character corresponding to the LED(s).", 0
 1367 000000D7 52 65 64 
              20 3D 20 
              52 2C 20 
              47 72 65 
              65 6E 20 
              3D 20 47 
              2C 20 42 
              6F 74 68 
              20 3D 20 
              42 2C 20 
              4E 6F 6E 
              65 20 3D 
              20 4E 2E 
              00       Instruct4
                               DCB              "Red = R, Green = G, Both = B, None = N.", 0
 1368 000000FF 54 68 65 
              72 65 20 
              61 72 65 
              20 31 30 
              20 72 6F 
              75 6E 64 
              73 20 6F 
              66 20 69 
              6E 63 72 
              65 61 73 
              69 6E 67 
              20 73 70 
              65 65 64 
              2E 20 54 
              68 69 6E 
              6B 20 79 



ARM Macro Assembler    Page 41 CMPE 250 Exercise Twelve


              6F 75 20 
              63 61 6E 
              20 68 61 
              6E 64 6C 
              65 20 69 
              74 3F 00 Instruct5
                               DCB              "There are 10 rounds of increasing speed. Think you can handle it?", 0
 1369 00000141 50 72 65 
              73 73 20 
              61 6E 79 
              20 6B 65 
              79 20 74 
              6F 20 62 
              65 67 69 
              6E 2E 20 
              47 6F 6F 
              64 20 6C 
              75 63 6B 
              21 00    Instruct6
                               DCB              "Press any key to begin. Good luck!", 0
 1370 00000164         
 1371 00000164 3A 20 20 
              43 6F 72 
              72 65 63 
              74 2D 2D 
              63 6F 6C 
              6F 72 20 
              77 61 73 
              20 00    CorrectMsg
                               DCB              ":  Correct--color was ", 0
 1372 0000017B 3A 20 20 
              57 72 6F 
              6E 67 00 WrongMsg
                               DCB              ":  Wrong", 0
 1373 00000184 58 3A 20 
              20 4F 75 
              74 20 6F 
              66 20 74 
              69 6D 65 
              2D 2D 63 
              6F 6C 6F 
              72 20 77 



ARM Macro Assembler    Page 42 CMPE 250 Exercise Twelve


              61 73 20 
              00       OutOfTimeMsg
                               DCB              "X:  Out of time--color was ", 0
 1374 000001A0 6E 6F 6E 
              65 00    NoneMsg DCB              "none", 0
 1375 000001A5 72 65 64 
              00       RedMsg  DCB              "red", 0
 1376 000001A9 67 72 65 
              65 6E 00 GreenMsg
                               DCB              "green", 0
 1377 000001AF 62 6F 74 
              68 00    BothMsg DCB              "both", 0
 1378 000001B4         
 1379 000001B4 54 68 61 
              6E 6B 20 
              79 6F 75 
              20 66 6F 
              72 20 70 
              6C 61 79 
              69 6E 67 
              20 74 68 
              65 20 53 
              75 70 65 
              72 20 46 
              75 6E 20 
              44 65 6C 
              75 78 65 
              20 4C 45 
              44 20 46 
              75 6E 20 
              47 61 6D 
              65 28 54 
              4D 29 21 
              00       ThanksMsg
                               DCB              "Thank you for playing the Super Fun Deluxe LED Fun Game(TM)!", 0
 1380 000001F1 59 6F 75 
              72 20 73 
              63 6F 72 
              65 20 77 
              61 73 3A 
              20 00    ScoreMsg
                               DCB              "Your score was: ", 0



ARM Macro Assembler    Page 43 CMPE 250 Exercise Twelve


 1381 00000202 57 6F 75 
              6C 64 20 
              79 6F 75 
              20 6C 69 
              6B 65 20 
              74 6F 20 
              70 6C 61 
              79 20 61 
              67 61 69 
              6E 3F 20 
              28 59 2F 
              4E 29 00 ReplayMsg
                               DCB              "Would you like to play again? (Y/N)", 0
 1382 00000226 47 6F 6F 
              64 62 79 
              65 21 00 GoodbyeMsg
                               DCB              "Goodbye!", 0
 1383 0000022F         
 1384 0000022F 3E 00   RightArrow
                               DCB              ">", 0
 1385 00000231 3C 00   LeftArrow
                               DCB              "<", 0
 1386 00000233         ;>>>>>   end constants here <<<<<
 1387 00000233 00              ALIGN
 1388 00000234         ;****************************************************************
 1389 00000234         ;Variables
 1390 00000234                 AREA             MyData,DATA,READWRITE
 1391 00000000         ;>>>>> begin variables here <<<<<
 1392 00000000 00 00 00 
              00       Score   SPACE            4
 1393 00000004 00 00 00 
              00       Count   SPACE            4
 1394 00000008 00      RunStopWatch
                               SPACE            1
 1395 00000009         
 1396 00000009 00 00 00        ALIGN
 1397 0000000C 00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 



ARM Macro Assembler    Page 44 CMPE 250 Exercise Twelve


              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00       String  SPACE            MAX_STRING
 1398 0000005B         
 1399 0000005B 00              ALIGN
 1400 0000005C 00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 



ARM Macro Assembler    Page 45 CMPE 250 Exercise Twelve


              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00    RxQueue SPACE            RxQBuffer
 1401 000000AC 00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 RxQRecord
                               SPACE            18
 1402 000000BE         
 1403 000000BE 00 00           ALIGN
 1404 000000C0 00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 



ARM Macro Assembler    Page 46 CMPE 250 Exercise Twelve


              00 00 00 
              00 00    TxQueue SPACE            TxQBuffer
 1405 00000110 00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 TxQRecord
                               SPACE            18
 1406 00000122         ;>>>>>   end variables here <<<<<
 1407 00000122 00 00           ALIGN
 1408 00000124                 END
Command Line: --debug --length=49 --width=120 --diag_suppress=9931 --cpu=Cortex-M0+ --apcs=interwork --depend=.\objects\
exercise12.d -o.\objects\exercise12.o -I.\RTE\_Target_1 -IC:\Keil_v5\ARM\PACK\Keil\Kinetis_KLxx_DFP\1.13.0\Device\Includ
e -IC:\Keil_v5\ARM\CMSIS\Include --predefine="__EVAL SETA 1" --predefine="__UVISION_VERSION SETA 524" --predefine="MKL46
Z256xxx4 SETA 1" --list=.\listings\exercise12.lst Exercise12.s
